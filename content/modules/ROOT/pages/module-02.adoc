= Store, Scan and Deploy Applications with Red Hat Quay

In this module we will be acting as the devloper.

==== Login to Quay

*Procedure*

[start=1]
. Run the following command.

Let's export a few variables to make things easier. These variables will stay in the .bashrc file so they're saved in case you need to refresh the terminal.

[source,sh,subs="attributes",role=execute]
----
echo export QUAY_USER={quay_admin_username} >> ~/.bashrc
QUAY_USER={quay_admin_username}
----

[start=2]

. Set the Quay URL variable 

[source,sh,subs="attributes",role=execute]
----
echo export QUAY_URL=$(oc -n quay-enterprise get route quay-quay -o jsonpath='{.spec.host}') >> ~/.bashrc
QUAY_URL=$(oc -n quay-enterprise get route quay-quay -o jsonpath='{.spec.host}')
----

IMPORTANT: Verify that the variables are correct

[source,sh,subs="attributes",role=execute]
----
echo $QUAY_USER
echo $QUAY_URL
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
[lab-user@bastion ~]$ echo $QUAY_USER
echo $QUAY_URL
quayadmin
quay-bq65l.apps.cluster-bq65l.bq65l.sandbox209.opentlc.com
----

[start=3]
. Using the terminal on the bastion host, login to quay using the Podman CLI as shown below:

[source,sh,subs="attributes",role=execute]
----
podman login $QUAY_URL
----

NOTE: Use the quay admin credentials to sign in. 

[cols="2,2"]
|===
*Quay Username:* | *{quay_admin_username}* |
*Quay Password:* | *{quay_admin_password}* |
|===

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Username: quayadmin
Password:
Login Succeeded!
----

=== Download a base container image

*Procedure*

. Run the following commands 

podman pull python:3.9-slim node:16

----
Resolved "python" as an alias (/etc/containers/registries.conf.d/000-shortnames.conf)
Trying to pull docker.io/library/python:3.9-slim...
Getting image source signatures
Copying blob d381bf0bfd6e done   | 
Copying blob 96df0e5e8179 done   | 
Copying blob fd674058ff8f done   | 
Copying blob 75a2bc32319e done   | 
Copying config 47e5116b5e done   | 
Writing manifest to image destination
47e5116b5ec1de854ad39b1868d3ea37555ff2ed7edb8dccc618db2427d490ae
----

[source,sh,subs="attributes",role=execute]
----
podman tag docker.io/library/python:3.9-slim $QUAY_URL/$QUAY_USER/python-slim-golden:0.1
podman tag docker.io/library/node:16 $QUAY_URL/$QUAY_USER/node-16-golden:0.1
----


Perfect! 

=== Add the application code & build the container image

In this section, we will download the "*TBD*" give it a new tag, and push the image to Quay. Later, we'll deploy the image to the OpenShift Cluster and use it in future modules.


TIP: With the variables saved in the ~/.bashrc file you will not have to declare them again in the future. 



echo $QUAY_URL/$QUAY_USER/python-slim-golden:0.1
echo $QUAY_URL/$QUAY_USER/node-16-golden:0.1

REGEX command to change the Dockerfiles

echo export TUTORIAL_HOME="$(pwd)/demo-apps") >> ~/.bashrc
export TUTORIAL_HOME="$(pwd)/demo-apps"

cd $TUTORIAL_HOME/flask-app/app/backend
podman build -t $QUAY_URL/$QUAY_USER/backend-python:0.1 .
podman push $QUAY_URL/$QUAY_USER/backend-python:0.1 --remove-signatures

cd $TUTORIAL_HOME/flask-app/app/frontend
podman build -t $QUAY_URL/$QUAY_USER/frontend-node:0.1 .
podman push $QUAY_URL/$QUAY_USER/frontend-node:0.1 --remove-signatures

NOTE: Quay will automatically create a private registry to store our TBD application since we have admin access. To deploy the app, you'll need to make the repository public so you can pull the image without credentials.

== Access Quay 

Your Red Hat Quay console is available at: {quay_console_url}[window=blank]

Administrator login is available with:

[source,sh,subs="attributes",role=execute]

[cols="1,1"]
|===
*Quay Console Username:* | {quay_admin_username} |
*Quay Console Password:* | {quay_admin_password} |
|===

[[navigating-the-registry]]

== Browse the registry

In the setup module we downloaded built and pushed a insecure java application called *ctf-web-to-system*. Now it's time to deploy it to the OpenShift Cluster. To do this we will need to make the registry that we created public. 

Let's take a look at our application in the registry.

image::quay-login.png[link=self, window=blank, width=100%]

. Next, click on the *ctf-web-to-system* repository. 

image::quay-repo.png[link=self, window=blank, width=100%]

On the left hand side of the window you should see the following icons labelled in order from top to bottom,

image::quay-sidebar.png[link=self, window=blank, width=100%]

- Information
- Tags
- Tag History
- Usage Logs
- Settings

The information tab shows you information such as;

- Podman and Docker commands
- Repository activity
- The repository description. 

image::quay-information.png[link=self, window=blank, width=100%]

[start=2]
. Click on the *Tags* icon. 

image::quay-tags.png[link=self, window=blank, width=100%]

This tab displays all of the images and tags that have been upladed, providing information such as fixable vulnerabilities, the image size and allows for bulk changes to images based on the security posture. 

image::quay-tags-security.png[link=self, window=blank, width=100%]

[start=3]
. Click on the *Tags History* icon. 

image::quay-tags-history.png[link=self, window=blank, width=100%]

This tab simply displays the container images history over time. 

[start=4]
. Click on the *Usage Logs* icon. 

This tab displays the usage over time along with details about who/how the images were pushed to the cluster. 

image::quay-usage-logs.png[link=self, window=blank, width=100%]

You can see that you (The "quayadmin") pushed an image tagged 1.0 to the repository today. 

[start=5]
. Lastly click on the *Settings* icon. 

image::quay-settings.png[link=self, window=blank, width=100%]

In this tab you can add/remove users and update permissions, alter the privacy of the repository, and even schedule alerts based on found vulnerabilities.

image::quay-tags-security.png[link=self, window=blank, width=100%]

IMPORTANT: Make sure to make the repository public. Otherwise we will not be able to deploy the application in the next step.

[start=6]
. Make your repository public before deploying our application in the next step by clicking the *Make Public* button under `Repository Visability`

image::quay-make-public.png[link=self, window=blank, width=100%]

[start=7]
. Click OK

image::quay-make-public-ok.png[link=self, window=blank, width=100%]

[[vulnerability-scanning-with-quay]]

== Vulnerability Scanning with Quay

Red Hat Quay can also help with securing our environments by performing a security scan on any images added to our registry, and advise which ones are potentially fixable.

Use the following procedure to check the security scan results for our Java container image you have uploaded.

. Click on the *Tags* icon on the left side of the screen like before.

image::quay-tags.png[link=self, window=blank, width=100%]

NOTE: You may need to click the checkbox near the image you would would like more information on, but the column for *Security Scan* should populate.

[start=2]
. By default, the security scan color codes the vulnerabilities, you can hover over the security scan for more information.

image::quay-scan-hover.png[link=self, window=blank, width=100%]

NOTE: The Java container image we are using in this lab shows 12 vulnerabilities, with 1 high vulnerabilities. This number will change with time and will be different between container scanners for a variety of reasons such as reporting mechanisms, vulnerability feeds and operating system support. 

. Click on the list of vulnerabilities to see a more detailed view.

image::quay-security-detailed.png[link=self, window=blank, width=100%, Image Security Details] 

. Click on a vulnerabile package on the left menu to get more information about the vulnerability and see what you have to do to fix the issue.

image::quay-vuln-detailed.png[link=self, window=blank, width=100%]

NOTE: Toggling for fixable/unfixable vulnerabilities is an excellent way for developers to understand what is within their responsibility for fixing. For example, since we are using an older version of Java, many fixes are available for these common issues. 

Congratulations, you now know how to examine images in your registry for potential vulnerabilities before deploying into your environment.

[subs=attributes]

IMPORTANT: Please ensure the deploy application are deployed to your cluster before moving onto the next module. 

[[deploy-the-java-application]]

==== Deploy the Application with RHACM

Perfect! 
