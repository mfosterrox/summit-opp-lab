= Red Hat Quay

In this session, participants will learn how to install and configure Quay to host images in a private registry that will be deployed via RHACM and secured via RHACS.

The goal of this portion of the lab is to show the value that Quay provides for local image management, and also how OpenShift Data Foundation can be used to provide peristent storage for applications deployed in the cluster, such as image repositories.

IMPORTANT: Several of the following tasks require use of the CLI, and should be run from the *Bastion* host in your lab environment. 

== Quay setup

=== Download the "Wordpress" application and push the container image to Quay via the Student VM

IMPORTANT: You will need to complete the following commands in the *Student VM*

For a simple task to demonstrate the functionality of Quay, we can pull an image from a public respository and then upload it to our newly created private registry. For this purpose we are going to use the ctf-web-to-system container image.

. First, let's export a few variable to make our life easier.

[source,sh,role=execute]
----
export QUAY_USER= {quay_admin_password}
----

[start=2]
. Set the Quay URL variable but make to REMOVE the *https://*

[source,sh,role=execute]
----
export QUAY_URL= {quay_console_url} #remove https://
----

[start=3]
. Using the terminal on the bastion host, login to quay using the Podman CLI as shown below:

[source,sh,role=execute]
----
podman login {quay_console_url}
----

NOTE: Make sure to use the quay admin credentials (Username: *{quay_admin_username}* & password: *{quay_admin_password}*). You can create unique user and group credentials in Quay for proper segmentation. 

*Sample command*
[source,bash,role="execute"]
----
podman login $QUAY_URL
----

*Sample output*
[source,bash]
----
Username: quayadmin
Password:
Login Succeeded!
----

[start=2]
. Pull the Wordpress container image with the following cli command:

[source,sh,role=execute]
----
podman pull quay.io/jechoisec/ctf-web-to-system-01
----

*Sample output*
[source,bash]
----
Trying to pull podman pull quay.io/jechoisec/ctf-web-to-system-01...
Getting image source signatures
Copying blob d3c894b5b2b0 done
Copying blob 960043b8858c done
Copying blob eebb06941f3e done
Copying blob 5c984a731132 done
Copying blob 02cd68c0cbf6 done
Copying blob ac1099dcb77c done
Copying blob b40161cd83fc done
Copying blob 46ba3f23f1d3 done
Copying blob 4fa131a1b726 done
Copying blob 5f367a3bfdcf done
Copying blob 9667fec0b471 done
Copying blob 9b509fdf4970 done
Copying blob 546ce7892922 done
Copying blob 20dd98444fbf done
Copying blob b25c8b834f22 done
Copying blob 83fba0af389a done
Copying blob 4c27f8a9a616 done
Copying blob 7cbc0c1e2e4c done
Copying blob c0a01ea16cdd done
Copying config f5857a0685 done
Writing manifest to image destination
WARNING: image platform (linux/arm64/v8) does not match the expected platform (linux/amd64)
f5857a06852012a8f7eb9b464eac419ec03d31e810b4d48ae1ea86131cd81475
----

. Now that you have a copy of the Wordpress container image locally. Let's tag the image and push it to our private registry using the following commands:

[source,sh,role=execute]
----
podman tag quay.io/jechoisec/ctf-web-to-system-01 $QUAY_URL/$QUAY_USER/ctf-web-to-system:1.0
----

[source,sh,role=execute]
----
podman push $QUAY_URL/$QUAY_USER/ctf-web-to-system:1.0 --remove-signatures
----

. Once the image is successfully pushed, we can browse the Quay UI to validate it.

. Click on the *Repositories* button, and you will be taken to a screen that shows our original empty repository, and the newly created Wordpress one.


== Demo application setup

This section will focus on downloading, and pushing an image to Red Hat Quay. This demo app will be the main focus throughout the roadshow. While there will be many other "Insecure" applications that will be deployed remember the "ctf-web-to-system" application will be the focus. 

=== Deploy the demo applications

Our insecure demo applications come from a variety of public GitHub repositories and sources.

[source,sh,subs="attributes",role=execute]
----
git clone https://github.com/mfosterrox/demo-apps.git roadshow-apps
export TUTORIAL_HOME="$(pwd)/roadshow-apps"
oc apply -f $TUTORIAL_HOME/kubernetes-manifests/ --recursive
----

[IMPORTANT]
You should see warnings
Warning: would violate PodSecurity "restricted:latest": unrestricted capabilities (container "ubi" must set securityContext.capabilities.drop=["ALL"]; container "ubi" must not include "SYS_ADMIN" in securityContext.capabilities.add), runAsNonRoot != true (pod or container "ubi" must set securityContext.runAsNonRoot=true), seccompProfile (pod or container "ubi" must set securityContext.seccompProfile.type to "RuntimeDefault" or "Localhost")

[NOTE] This command applies a plethora of manifests to your environment. The important part is that the deployments are up and running. Run the following command and ensure that the applications are up and running

[source,bash,role="execute"]
----
kubectl get deployments -l demo=roadshow -A
----

*Output*
```bash
NAMESPACE    NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
backend      api-server              1/1     1            1           72m
default      adservice               1/1     1            1           67m
default      api-server              1/1     1            1           71m
default      cartservice             1/1     1            1           67m
default      checkoutservice         1/1     1            1           67m
default      ctf-web-to-system       1/1     1            1           72m
default      currencyservice         1/1     1            1           67m
default      emailservice            1/1     1            1           67m
default      frontend                1/1     1            1           71m
default      juice-shop              1/1     1            1           57m
default      loadgenerator           1/1     1            1           66m
default      paymentservice          1/1     1            1           66m
default      productcatalogservice   1/1     1            1           66m
default      rce                     1/1     1            1           71m
default      recommendationservice   1/1     1            1           66m
default      redis-cart              1/1     1            1           66m
default      reporting               1/1     1            1           71m
default      shippingservice         1/1     1            1           67m
frontend     asset-cache             1/1     1            1           71m
medical      reporting               1/1     1            1           71m
operations   jump-host               1/1     1            1           71m
payments     visa-processor          1/1     1            1           71m
```


[NOTE]
the main focus needs to be that the *ctf-web-to-system* application deployed properly. 

=== OpenShift pipeline setup

==== Update the pipeline yamls 

[source,bash,role="execute"]
----
sed -i 's|image: centos:8|image: quay-cw8nq.apps.cluster-cw8nq.sandbox1394.opentlc.com/quayadmin/ctf-web-to-system|g' $TUTORIAL_HOME/openshift-pipelines/tasks/rox-deployment-check-task.yml
sed -i 's|image: centos:8|image: quay-cw8nq.apps.cluster-cw8nq.sandbox1394.opentlc.com/quayadmin/ctf-web-to-system|g' $TUTORIAL_HOME/openshift-pipelines/tasks/rox-image-check-task.yml
sed -i 's|image: centos:8|image: quay-cw8nq.apps.cluster-cw8nq.sandbox1394.opentlc.com/quayadmin/ctf-web-to-system|g' $TUTORIAL_HOME/openshift-pipelines/tasks/rox-image-scan-task.yml
----

[source,bash,role="execute"]
----
oc apply -f $TUTORIAL_HOME/kubernetes-manifests/ --recursive
----




== Security Scanning

Red Hat Quay can also help with securing our environments by performing a security scan on any images added to our registry, and advise which ones are potentially fixable.

We can use the following procedure to check the security scan results for our UBI image we just uploaded.

. Click on the ubi repository and once inside click on the tags button on the left.
+
image::311-image-tags.png[link=self, window=blank, width=100%, Image Tag Menu]
+
NOTE: You may need to click the checkbox near the image you would would like more information on, but the column for *Security Scan* should populate.
+
. By default, the security scan color codes the vulnerabilities, you can hover over the security scan for more information.
+
image::312-quay-sec-scan.png[link=self, window=blank, width=100%, Quay Security Scan]
+
NOTE: The ubi image we are using in this lab shows 36 medium vulnerabilities, and 187 total when you hover over it at the time of this lab's creation.
+
. Click on the list of vulnerabilities to see a more detailed view.
+
image::313-security-details.png[link=self, window=blank, width=100%, Image Security Details] 
+
. Click the packages button on the left menu to see which specific packages in the image are affected by what vulnerabilities.
+
image::314-image-packages.png[link=self, window=blank, width=100%, Image Packages]
+
Congratulations, you now know how to examine images in your registry for potential vulnerabilities before deploying into your environment.

IMPORTANT: As of the creation date of this lab the list of vulnerabilties and the scores assigned to the images may differ from those provided by the image scanning tools available in Red Hat Advanced Cluster Security for Kuberenetes. Beginning with updated versions to be released in Spring of 2024 these values will begin to coalesce. It's entirely possible this will be the case by the time you participate in this lab, if you attempt to replicate outside of this lab environment. 

[subs=attributes+]

== Conclusion

We hope you have enjoyed this lab using Red Hat Quay to create and host your own repository, upload and use an image, and examine the image for security vulnerabilites. 
Overall this lab has been dedicated to exploring many of the features added when upgrading an OpenShift Container Platform subscription to OpenShift Platform Plus. 
At this time you have completed all of the tasks assigned in this lab, and you may freely explore the lab environment with the time you have remaining.

