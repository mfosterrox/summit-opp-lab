= Red Hat Quay

Red Hat Quay is an enterprise-quality registry for building, securing and serving container images. It provides secure storage, distribution, governance of containers and cloud-native artifacts on any infrastructure.

Manual deployments of Red Hat Quay involves multiple sub-components and the overhead of managing those components. Red Hat Quay is best deployed on Red Hat OpenShift using the Operators which simplifies the deployment and manages all the components. It also gives you the option of keeping any of the components self-managed.

To get started, let's log in to Red Hat Quay.

== Access Quay 

Your Red Hat Quay console is available at: {quay_console_url}[window=blank]

Administrator login is available with:

[cols="1,1"]
|===
*Quay Console Username:* | {quay_admin_username} |
*Quay Console Password:* | {quay_admin_password} |
|===

== Browse the registry

In the setup module we downloaded built and pushed a insecure java application called *ctf-web-to-system*. Now it's time to deploy it to the OpenShift Cluster. To do this we will need to make the registry that we created public. 

Let's take a look at our application in the registry.

. 


== Vulnerability Scanning with Quay

Red Hat Quay can also help with securing our environments by performing a security scan on any images added to our registry, and advise which ones are potentially fixable.

[source,sh,subs="attributes",role=execute]

We can use the following procedure to check the security scan results for our UBI image we just uploaded.

. Click on the ubi repository and once inside click on the tags button on the left.
+
image::311-image-tags.png[link=self, window=blank, width=100%, Image Tag Menu]
+
NOTE: You may need to click the checkbox near the image you would would like more information on, but the column for *Security Scan* should populate.
+
. By default, the security scan color codes the vulnerabilities, you can hover over the security scan for more information.
+
image::312-quay-sec-scan.png[link=self, window=blank, width=100%, Quay Security Scan]
+
NOTE: The ubi image we are using in this lab shows 36 medium vulnerabilities, and 187 total when you hover over it at the time of this lab's creation.
+
. Click on the list of vulnerabilities to see a more detailed view.
+
image::313-security-details.png[link=self, window=blank, width=100%, Image Security Details] 
+
. Click the packages button on the left menu to see which specific packages in the image are affected by what vulnerabilities.
+
image::314-image-packages.png[link=self, window=blank, width=100%, Image Packages]
+
Congratulations, you now know how to examine images in your registry for potential vulnerabilities before deploying into your environment.

IMPORTANT: As of the creation date of this lab the list of vulnerabilties and the scores assigned to the images may differ from those provided by the image scanning tools available in Red Hat Advanced Cluster Security for Kuberenetes. Beginning with updated versions to be released in Spring of 2024 these values will begin to coalesce. It's entirely possible this will be the case by the time you participate in this lab, if you attempt to replicate outside of this lab environment. 

[subs=attributes+]

=== Deploy the demo applications

Our insecure demo applications come from a variety of public GitHub repositories and sources. Including the Java app that you just pushed to Quay. Let's deploy them into our cluster.

. Run the following command in the Bastion VM. 

[NOTE]
This command downloads a bunch of Kubernetes manifests to deploy to OpenShift. We also add the location of the local repository for our ctf-web-to-system application. 

[source,sh,subs="attributes",role=execute]
----
git clone https://github.com/mfosterrox/demo-apps.git roadshow-apps
export TUTORIAL_HOME="$(pwd)/roadshow-apps"
sed -i "s|quay.io/jechoisec/ctf-web-to-system-01|$QUAY_URL/$QUAY_USER/ctf-web-to-system:1.0|g" $TUTORIAL_HOME/kubernetes-manifests/ctf-web-to-system/ctf-w2s.yml
oc apply -f $TUTORIAL_HOME/kubernetes-manifests/ --recursive
oc apply -f $TUTORIAL_HOME/openshift-pipelines/ --recursive
----

[IMPORTANT]
You should see warnings such as: Warning: would violate PodSecurity "restricted:latest": unrestricted capabilities (container "ubi" must set securityContext.capabilities.drop=["ALL"]) this is because we are deploying flawed container configurations and vulnerabile container applications into the OpenShift cluster.


[start=2]
. Run the following command and ensure that the applications are up and running

[source,bash,role="execute"]
----
kubectl get deployments -l demo=roadshow -A
----

*Output*
```bash
NAMESPACE    NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
backend      api-server              1/1     1            1           72m
default      adservice               1/1     1            1           67m
default      api-server              1/1     1            1           71m
default      cartservice             1/1     1            1           67m
default      checkoutservice         1/1     1            1           67m
default      ctf-web-to-system       1/1     1            1           72m
default      currencyservice         1/1     1            1           67m
default      emailservice            1/1     1            1           67m
default      frontend                1/1     1            1           71m
default      juice-shop              1/1     1            1           57m
default      loadgenerator           1/1     1            1           66m
default      paymentservice          1/1     1            1           66m
default      productcatalogservice   1/1     1            1           66m
default      rce                     1/1     1            1           71m
default      recommendationservice   1/1     1            1           66m
default      redis-cart              1/1     1            1           66m
default      reporting               1/1     1            1           71m
default      shippingservice         1/1     1            1           67m
frontend     asset-cache             1/1     1            1           71m
medical      reporting               1/1     1            1           71m
operations   jump-host               1/1     1            1           71m
payments     visa-processor          1/1     1            1           71m
```

[NOTE]
The main focus needs to be that the *ctf-web-to-system* application deployed properly. 


Nice Job! Please move onto the next module.


== Conclusion

We hope you have enjoyed this lab using Red Hat Quay to create and host your own repository, upload and use an image, and examine the image for security vulnerabilites. 

